<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›Œí”„ìŠ¤íƒ€ ì½˜í…ì¸  í¬ë¦¬ì—ì´í„° - ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .admin-header {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .logo-dot {
            color: #8A4FFF;
            font-size: 28px;
            margin-right: 8px;
        }
        .admin-title {
            margin: 20px 0;
            color: #333;
        }
        .admin-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .admin-card h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .user-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .user-list th, .user-list td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .user-list th {
            background-color: #f9f9f9;
        }
        .user-list tr:hover {
            background-color: #f5f5f5;
        }
        .vip-tag {
            background-color: #8A4FFF;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .action-button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .vip-button {
            background-color: #8A4FFF;
            color: white;
        }
        .delete-button {
            background-color: #E84855;
            color: white;
        }
        .back-button {
            padding: 8px 15px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .message {
            padding: 10px 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="admin-logo">
            <span class="logo-dot">ğŸŸ£</span>
            <span>ì›Œí”„ìŠ¤íƒ€ Content Creator</span>
        </div>
        <button class="back-button" onclick="goBack()">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <div class="admin-container">
        <h1 class="admin-title">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        
        <div id="message-container"></div>

        <div class="admin-card">
            <h2>ì‚¬ìš©ì ê´€ë¦¬</h2>
            <table class="user-list" id="user-table">
                <thead>
                    <tr>
                        <th>ì•„ì´ë””</th>
                        <th>ê°€ì…ì¼</th>
                        <th>ë©¤ë²„ì‹­ ìƒíƒœ</th>
                        <th>VIP ë§Œë£Œì¼</th>
                        <th>ìƒíƒœ</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="user-list-body">
                    <!-- ì‚¬ìš©ì ëª©ë¡ì´ JavaScriptë¡œ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                </tbody>
            </table>
        </div>

        <div class="admin-card">
            <h2>í†µê³„</h2>
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>ì´ ì‚¬ìš©ì:</strong> <span id="total-users">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>VIP ì‚¬ìš©ì:</strong> <span id="vip-users">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>ì˜¤ëŠ˜ ìƒì„±ëœ ì½˜í…ì¸ :</strong> <span id="contents-today">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>ì´ ì½˜í…ì¸  ìƒì„±ìˆ˜:</strong> <span id="total-contents">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        function goBack() {
            window.location.href = "/";
        }

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(text, type) {
            const messageContainer = document.getElementById('message-container');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = text;
            messageContainer.appendChild(messageElement);
            
            // ìë™ ì œê±°
            setTimeout(() => {
                messageElement.style.opacity = '0';
                messageElement.style.transition = 'opacity 0.5s';
                setTimeout(() => messageContainer.removeChild(messageElement), 500);
            }, 4000);
        }

        // APIë¡œ ì‚¬ìš©ì ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchUsers() {
            try {
                // API ì—”ë“œí¬ì¸íŠ¸ê°€ ì—†ìœ¼ë¯€ë¡œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì™€ ë°ì´í„°ë² ì´ìŠ¤ ë°ì´í„°ë¥¼ í†µí•©í•˜ì—¬ í‘œì‹œ
                // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const localUsers = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                console.log('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ì:', localUsers);
                
                // 2. ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ ì‹œë®¬ë ˆì´ì…˜ (DatabaseInitializerì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ í–ˆë‹¤ë©´ ì¡´ì¬í•´ì•¼ í•¨)
                let dbUsers = [];
                try {
                    // ë¸Œë¼ìš°ì € ì €ì¥ì†Œì— ì„ì‹œë¡œ ì €ì¥ëœ DB ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (dbService.jsì—ì„œ ì €ì¥í•œ ë°ì´í„°)
                    const dbUsersJson = localStorage.getItem('db_users_cache');
                    if (dbUsersJson) {
                        dbUsers = JSON.parse(dbUsersJson);
                        console.log('ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì (ìºì‹œ):', dbUsers);
                    }
                } catch (e) {
                    console.error('ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì ì¡°íšŒ ì˜¤ë¥˜:', e);
                }
                
                // ë‘ ë°ì´í„° ì†ŒìŠ¤ í†µí•© (ì¤‘ë³µ ì‚¬ìš©ìëŠ” ë°ì´í„°ë² ì´ìŠ¤ ë²„ì „ ìš°ì„ )
                const combinedUsers = [...localUsers];
                
                // DB ì‚¬ìš©ìê°€ ìˆìœ¼ë©´ ë³‘í•© (usernameìœ¼ë¡œ êµ¬ë¶„)
                dbUsers.forEach(dbUser => {
                    const existingIndex = combinedUsers.findIndex(u => 
                        u.username && dbUser.username && 
                        u.username.toLowerCase() === dbUser.username.toLowerCase()
                    );
                    
                    if (existingIndex >= 0) {
                        // ê¸°ì¡´ ì‚¬ìš©ì ì—…ë°ì´íŠ¸
                        combinedUsers[existingIndex] = {
                            ...combinedUsers[existingIndex],
                            ...dbUser,
                            // DB í˜•ì‹ì˜ í•„ë“œëª…ì„ í´ë¼ì´ì–¸íŠ¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                            membershipType: dbUser.membership_type || combinedUsers[existingIndex].membershipType,
                            vipStatus: dbUser.vip_status || combinedUsers[existingIndex].vipStatus,
                            membershipExpiry: dbUser.membership_expiry || combinedUsers[existingIndex].membershipExpiry,
                            createdAt: dbUser.created_at || combinedUsers[existingIndex].createdAt,
                            updatedAt: dbUser.updated_at || combinedUsers[existingIndex].updatedAt
                        };
                    } else {
                        // ìƒˆ ì‚¬ìš©ì ì¶”ê°€ (DB í˜•ì‹ì˜ í•„ë“œëª…ì„ í´ë¼ì´ì–¸íŠ¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜)
                        combinedUsers.push({
                            username: dbUser.username,
                            // ë³´ì•ˆìƒ ë¹„ë°€ë²ˆí˜¸ëŠ” í¬í•¨í•˜ì§€ ì•ŠìŒ
                            membershipType: dbUser.membership_type || 'basic',
                            vipStatus: dbUser.vip_status || 'none',
                            membershipExpiry: dbUser.membership_expiry || null,
                            createdAt: dbUser.created_at || new Date().toISOString(),
                            updatedAt: dbUser.updated_at || new Date().toISOString()
                        });
                    }
                });
                
                return combinedUsers;
            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                showMessage('ì‚¬ìš©ì ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                return [];
            }
        }

        // VIP ìƒíƒœ ë³€ê²½ í•¨ìˆ˜
        async function changeVipStatus(username, makeVip) {
            try {
                // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                const users = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                const userIndex = users.findIndex(user => user.username === username);
                
                if (userIndex !== -1) {
                    // VIP ìƒíƒœ ë³€ê²½
                    if (makeVip) {
                        // VIPë¡œ ì—…ê·¸ë ˆì´ë“œ
                        const today = new Date();
                        const expiryDate = new Date(today);
                        expiryDate.setDate(today.getDate() + 30); // 30ì¼ í›„
                        
                        users[userIndex].membershipType = 'vip';
                        users[userIndex].vipStatus = 'approved';
                        users[userIndex].membershipExpiry = expiryDate.toISOString();
                        users[userIndex].updatedAt = new Date().toISOString();
                    } else {
                        // VIP ì œê±°
                        users[userIndex].membershipType = 'basic';
                        users[userIndex].vipStatus = 'none';
                        users[userIndex].membershipExpiry = null;
                        users[userIndex].updatedAt = new Date().toISOString();
                    }
                    
                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                    localStorage.setItem('smart_content_users', JSON.stringify(users));
                }
                
                // 2. ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹¤ì œë¡œëŠ” API í˜¸ì¶œì´ í•„ìš”í•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” ìºì‹œ ì—…ë°ì´íŠ¸ë¡œ ì‹œë®¬ë ˆì´ì…˜)
                try {
                    const dbUsersJson = localStorage.getItem('db_users_cache');
                    if (dbUsersJson) {
                        const dbUsers = JSON.parse(dbUsersJson);
                        const dbUserIndex = dbUsers.findIndex(user => user.username === username);
                        
                        if (dbUserIndex !== -1) {
                            if (makeVip) {
                                const today = new Date();
                                const expiryDate = new Date(today);
                                expiryDate.setDate(today.getDate() + 30); // 30ì¼ í›„
                                
                                dbUsers[dbUserIndex].membership_type = 'vip';
                                dbUsers[dbUserIndex].vip_status = 'approved';
                                dbUsers[dbUserIndex].membership_expiry = expiryDate.toISOString();
                                dbUsers[dbUserIndex].updated_at = new Date().toISOString();
                            } else {
                                dbUsers[dbUserIndex].membership_type = 'basic';
                                dbUsers[dbUserIndex].vip_status = 'none';
                                dbUsers[dbUserIndex].membership_expiry = null;
                                dbUsers[dbUserIndex].updated_at = new Date().toISOString();
                            }
                            
                            localStorage.setItem('db_users_cache', JSON.stringify(dbUsers));
                        }
                    }
                } catch (e) {
                    console.error('ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', e);
                }
                
                const actionText = makeVip ? 'VIPë¡œ ì—…ê·¸ë ˆì´ë“œ' : 'VIP ê¶Œí•œ ì œê±°';
                showMessage(`ì‚¬ìš©ì '${username}'ê°€ ${actionText} ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                
                // í…Œì´ë¸” ë‹¤ì‹œ ë¡œë“œ
                loadUsers();
            } catch (error) {
                console.error('VIP ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error);
                showMessage('VIP ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ì‚¬ìš©ì ì‚­ì œ í•¨ìˆ˜
        async function deleteUser(username) {
            if (confirm(`ì •ë§ë¡œ ì‚¬ìš©ì '${username}'ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                try {
                    // ê´€ë¦¬ìëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŒ
                    if (username === '1111') {
                        showMessage('ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                    
                    // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì‚­ì œ
                    const users = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                    const filteredUsers = users.filter(user => user.username !== username);
                    localStorage.setItem('smart_content_users', JSON.stringify(filteredUsers));
                    
                    // 2. ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚¬ìš©ì ì‚­ì œ (ì‹¤ì œë¡œëŠ” API í˜¸ì¶œì´ í•„ìš”í•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” ìºì‹œ ì—…ë°ì´íŠ¸ë¡œ ì‹œë®¬ë ˆì´ì…˜)
                    try {
                        const dbUsersJson = localStorage.getItem('db_users_cache');
                        if (dbUsersJson) {
                            const dbUsers = JSON.parse(dbUsersJson);
                            const filteredDbUsers = dbUsers.filter(user => user.username !== username);
                            localStorage.setItem('db_users_cache', JSON.stringify(filteredDbUsers));
                        }
                    } catch (e) {
                        console.error('ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì ì‚­ì œ ì˜¤ë¥˜:', e);
                    }
                    
                    showMessage(`ì‚¬ìš©ì '${username}'ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    
                    // í…Œì´ë¸” ë‹¤ì‹œ ë¡œë“œ
                    loadUsers();
                } catch (error) {
                    console.error('ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                    showMessage('ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }
        
        // ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadUsers() {
            const userListBody = document.getElementById('user-list-body');
            userListBody.innerHTML = '';
            
            try {
                // APIì—ì„œ ì‚¬ìš©ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const users = await fetchUsers();
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('total-users').textContent = users.length;
                document.getElementById('vip-users').textContent = users.filter(user => 
                    user.membershipType === 'vip' && user.vipStatus === 'approved'
                ).length;
                
                // ì½˜í…ì¸  í†µê³„ëŠ” ë”ë¯¸ ë°ì´í„° ì‚¬ìš©
                document.getElementById('contents-today').textContent = Math.floor(Math.random() * 20);
                document.getElementById('total-contents').textContent = Math.floor(Math.random() * 200) + 50;
                
                // ì‚¬ìš©ì ëª©ë¡ì´ ë¹„ì–´ìˆëŠ” ê²½ìš°
                if (users.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="6" style="text-align: center;">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>`;
                    userListBody.appendChild(row);
                    return;
                }
                
                // ê° ì‚¬ìš©ì í–‰ ìƒì„±
                users.forEach(user => {
                    const isVip = user.membershipType === 'vip' && user.vipStatus === 'approved';
                    const row = document.createElement('tr');
                    
                    // VIP ë§Œë£Œì¼ ê³„ì‚°
                    let expiryText = '-';
                    if (isVip && user.membershipExpiry) {
                        const expiryDate = new Date(user.membershipExpiry);
                        expiryText = expiryDate.toLocaleDateString();
                    }
                    
                    // ê°€ì…ì¼ ê³„ì‚°
                    let createdAtText = 'ì•Œ ìˆ˜ ì—†ìŒ';
                    if (user.createdAt) {
                        createdAtText = new Date(user.createdAt).toLocaleDateString();
                    }
                    
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${createdAtText}</td>
                        <td>${isVip ? '<span class="vip-tag">VIP</span>' : 'ì¼ë°˜íšŒì›'}</td>
                        <td>${expiryText}</td>
                        <td>${user.vipStatus === 'pending' ? 'ìŠ¹ì¸ ëŒ€ê¸°ì¤‘' : '-'}</td>
                        <td>
                            ${isVip 
                                ? `<button class="action-button delete-button" onclick="changeVipStatus('${user.username}', false)">VIP í•´ì œ</button>`
                                : `<button class="action-button vip-button" onclick="changeVipStatus('${user.username}', true)">VIP ë¶€ì—¬</button>`
                            }
                            <button class="action-button delete-button" onclick="deleteUser('${user.username}')">ì‚­ì œ</button>
                        </td>
                    `;
                    
                    userListBody.appendChild(row);
                });
            } catch (error) {
                console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                showMessage('ì‚¬ìš©ì ëª©ë¡ì„ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" style="text-align: center; color: red;">ì‚¬ìš©ì ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td>`;
                userListBody.appendChild(row);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('load', () => {
            loadUsers();
            showMessage('ê´€ë¦¬ì í˜ì´ì§€ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤.', 'info');
        });
    </script>
</body>
</html>
