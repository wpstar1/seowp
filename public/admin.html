<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>워프스타 콘텐츠 크리에이터 - 관리자 페이지</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .admin-header {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .logo-dot {
            color: #8A4FFF;
            font-size: 28px;
            margin-right: 8px;
        }
        .admin-title {
            margin: 20px 0;
            color: #333;
        }
        .admin-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .admin-card h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .user-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .user-list th, .user-list td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .user-list th {
            background-color: #f9f9f9;
        }
        .user-list tr:hover {
            background-color: #f5f5f5;
        }
        .vip-tag {
            background-color: #8A4FFF;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .action-button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .vip-button {
            background-color: #8A4FFF;
            color: white;
        }
        .delete-button {
            background-color: #E84855;
            color: white;
        }
        .back-button {
            padding: 8px 15px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .message {
            padding: 10px 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="admin-logo">
            <span class="logo-dot">🟣</span>
            <span>워프스타 Content Creator</span>
        </div>
        <button class="back-button" onclick="goBack()">메인으로 돌아가기</button>
    </div>

    <div class="admin-container">
        <h1 class="admin-title">관리자 대시보드</h1>
        
        <div id="message-container"></div>

        <div class="admin-card">
            <h2>사용자 관리</h2>
            <table class="user-list" id="user-table">
                <thead>
                    <tr>
                        <th>아이디</th>
                        <th>가입일</th>
                        <th>멤버십 상태</th>
                        <th>VIP 만료일</th>
                        <th>상태</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="user-list-body">
                    <!-- 사용자 목록이 JavaScript로 여기에 로드됩니다 -->
                </tbody>
            </table>
        </div>

        <div class="admin-card">
            <h2>통계</h2>
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>총 사용자:</strong> <span id="total-users">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>VIP 사용자:</strong> <span id="vip-users">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>오늘 생성된 콘텐츠:</strong> <span id="contents-today">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>총 콘텐츠 생성수:</strong> <span id="total-contents">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 메인으로 돌아가기
        function goBack() {
            window.location.href = "/";
        }

        // 메시지 표시 함수
        function showMessage(text, type) {
            const messageContainer = document.getElementById('message-container');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = text;
            messageContainer.appendChild(messageElement);
            
            // 자동 제거
            setTimeout(() => {
                messageElement.style.opacity = '0';
                messageElement.style.transition = 'opacity 0.5s';
                setTimeout(() => messageContainer.removeChild(messageElement), 500);
            }, 4000);
        }

        // API로 사용자 데이터 가져오기
        async function fetchUsers() {
            try {
                // API 엔드포인트가 없으므로 로컬 스토리지와 데이터베이스 데이터를 통합하여 표시
                // 1. 로컬 스토리지에서 데이터 가져오기
                const localUsers = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                console.log('로컬 스토리지 사용자:', localUsers);
                
                // 2. 데이터베이스에서 가져온 데이터를 시뮬레이션 (DatabaseInitializer에서 마이그레이션 했다면 존재해야 함)
                let dbUsers = [];
                try {
                    // 브라우저 저장소에 임시로 저장된 DB 데이터 가져오기 (dbService.js에서 저장한 데이터)
                    const dbUsersJson = localStorage.getItem('db_users_cache');
                    if (dbUsersJson) {
                        dbUsers = JSON.parse(dbUsersJson);
                        console.log('데이터베이스 사용자 (캐시):', dbUsers);
                    }
                } catch (e) {
                    console.error('데이터베이스 사용자 조회 오류:', e);
                }
                
                // 두 데이터 소스 통합 (중복 사용자는 데이터베이스 버전 우선)
                const combinedUsers = [...localUsers];
                
                // DB 사용자가 있으면 병합 (username으로 구분)
                dbUsers.forEach(dbUser => {
                    const existingIndex = combinedUsers.findIndex(u => 
                        u.username && dbUser.username && 
                        u.username.toLowerCase() === dbUser.username.toLowerCase()
                    );
                    
                    if (existingIndex >= 0) {
                        // 기존 사용자 업데이트
                        combinedUsers[existingIndex] = {
                            ...combinedUsers[existingIndex],
                            ...dbUser,
                            // DB 형식의 필드명을 클라이언트 형식으로 변환
                            membershipType: dbUser.membership_type || combinedUsers[existingIndex].membershipType,
                            vipStatus: dbUser.vip_status || combinedUsers[existingIndex].vipStatus,
                            membershipExpiry: dbUser.membership_expiry || combinedUsers[existingIndex].membershipExpiry,
                            createdAt: dbUser.created_at || combinedUsers[existingIndex].createdAt,
                            updatedAt: dbUser.updated_at || combinedUsers[existingIndex].updatedAt
                        };
                    } else {
                        // 새 사용자 추가 (DB 형식의 필드명을 클라이언트 형식으로 변환)
                        combinedUsers.push({
                            username: dbUser.username,
                            // 보안상 비밀번호는 포함하지 않음
                            membershipType: dbUser.membership_type || 'basic',
                            vipStatus: dbUser.vip_status || 'none',
                            membershipExpiry: dbUser.membership_expiry || null,
                            createdAt: dbUser.created_at || new Date().toISOString(),
                            updatedAt: dbUser.updated_at || new Date().toISOString()
                        });
                    }
                });
                
                return combinedUsers;
            } catch (error) {
                console.error('사용자 데이터 가져오기 오류:', error);
                showMessage('사용자 데이터를 가져오는 중 오류가 발생했습니다.', 'error');
                return [];
            }
        }

        // VIP 상태 변경 함수
        async function changeVipStatus(username, makeVip) {
            try {
                // 1. 로컬 스토리지 업데이트
                const users = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                const userIndex = users.findIndex(user => user.username === username);
                
                if (userIndex !== -1) {
                    // VIP 상태 변경
                    if (makeVip) {
                        // VIP로 업그레이드
                        const today = new Date();
                        const expiryDate = new Date(today);
                        expiryDate.setDate(today.getDate() + 30); // 30일 후
                        
                        users[userIndex].membershipType = 'vip';
                        users[userIndex].vipStatus = 'approved';
                        users[userIndex].membershipExpiry = expiryDate.toISOString();
                        users[userIndex].updatedAt = new Date().toISOString();
                    } else {
                        // VIP 제거
                        users[userIndex].membershipType = 'basic';
                        users[userIndex].vipStatus = 'none';
                        users[userIndex].membershipExpiry = null;
                        users[userIndex].updatedAt = new Date().toISOString();
                    }
                    
                    // 로컬 스토리지 업데이트
                    localStorage.setItem('smart_content_users', JSON.stringify(users));
                }
                
                // 2. 데이터베이스 상태 업데이트 (실제로는 API 호출이 필요하지만 여기서는 캐시 업데이트로 시뮬레이션)
                try {
                    const dbUsersJson = localStorage.getItem('db_users_cache');
                    if (dbUsersJson) {
                        const dbUsers = JSON.parse(dbUsersJson);
                        const dbUserIndex = dbUsers.findIndex(user => user.username === username);
                        
                        if (dbUserIndex !== -1) {
                            if (makeVip) {
                                const today = new Date();
                                const expiryDate = new Date(today);
                                expiryDate.setDate(today.getDate() + 30); // 30일 후
                                
                                dbUsers[dbUserIndex].membership_type = 'vip';
                                dbUsers[dbUserIndex].vip_status = 'approved';
                                dbUsers[dbUserIndex].membership_expiry = expiryDate.toISOString();
                                dbUsers[dbUserIndex].updated_at = new Date().toISOString();
                            } else {
                                dbUsers[dbUserIndex].membership_type = 'basic';
                                dbUsers[dbUserIndex].vip_status = 'none';
                                dbUsers[dbUserIndex].membership_expiry = null;
                                dbUsers[dbUserIndex].updated_at = new Date().toISOString();
                            }
                            
                            localStorage.setItem('db_users_cache', JSON.stringify(dbUsers));
                        }
                    }
                } catch (e) {
                    console.error('데이터베이스 사용자 상태 업데이트 오류:', e);
                }
                
                const actionText = makeVip ? 'VIP로 업그레이드' : 'VIP 권한 제거';
                showMessage(`사용자 '${username}'가 ${actionText} 되었습니다.`, 'success');
                
                // 테이블 다시 로드
                loadUsers();
            } catch (error) {
                console.error('VIP 상태 변경 중 오류:', error);
                showMessage('VIP 상태 변경 중 오류가 발생했습니다.', 'error');
            }
        }
        
        // 사용자 삭제 함수
        async function deleteUser(username) {
            if (confirm(`정말로 사용자 '${username}'를 삭제하시겠습니까?`)) {
                try {
                    // 관리자는 삭제할 수 없음
                    if (username === '1111') {
                        showMessage('관리자 계정은 삭제할 수 없습니다.', 'error');
                        return;
                    }
                    
                    // 1. 로컬 스토리지에서 사용자 삭제
                    const users = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                    const filteredUsers = users.filter(user => user.username !== username);
                    localStorage.setItem('smart_content_users', JSON.stringify(filteredUsers));
                    
                    // 2. 데이터베이스에서 사용자 삭제 (실제로는 API 호출이 필요하지만 여기서는 캐시 업데이트로 시뮬레이션)
                    try {
                        const dbUsersJson = localStorage.getItem('db_users_cache');
                        if (dbUsersJson) {
                            const dbUsers = JSON.parse(dbUsersJson);
                            const filteredDbUsers = dbUsers.filter(user => user.username !== username);
                            localStorage.setItem('db_users_cache', JSON.stringify(filteredDbUsers));
                        }
                    } catch (e) {
                        console.error('데이터베이스 사용자 삭제 오류:', e);
                    }
                    
                    showMessage(`사용자 '${username}'가 삭제되었습니다.`, 'success');
                    
                    // 테이블 다시 로드
                    loadUsers();
                } catch (error) {
                    console.error('사용자 삭제 중 오류:', error);
                    showMessage('사용자 삭제 중 오류가 발생했습니다.', 'error');
                }
            }
        }
        
        // 사용자 목록 불러오기
        async function loadUsers() {
            const userListBody = document.getElementById('user-list-body');
            userListBody.innerHTML = '';
            
            try {
                // API에서 사용자 목록 가져오기
                const users = await fetchUsers();
                
                // 통계 업데이트
                document.getElementById('total-users').textContent = users.length;
                document.getElementById('vip-users').textContent = users.filter(user => 
                    user.membershipType === 'vip' && user.vipStatus === 'approved'
                ).length;
                
                // 콘텐츠 통계는 더미 데이터 사용
                document.getElementById('contents-today').textContent = Math.floor(Math.random() * 20);
                document.getElementById('total-contents').textContent = Math.floor(Math.random() * 200) + 50;
                
                // 사용자 목록이 비어있는 경우
                if (users.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="6" style="text-align: center;">등록된 사용자가 없습니다.</td>`;
                    userListBody.appendChild(row);
                    return;
                }
                
                // 각 사용자 행 생성
                users.forEach(user => {
                    const isVip = user.membershipType === 'vip' && user.vipStatus === 'approved';
                    const row = document.createElement('tr');
                    
                    // VIP 만료일 계산
                    let expiryText = '-';
                    if (isVip && user.membershipExpiry) {
                        const expiryDate = new Date(user.membershipExpiry);
                        expiryText = expiryDate.toLocaleDateString();
                    }
                    
                    // 가입일 계산
                    let createdAtText = '알 수 없음';
                    if (user.createdAt) {
                        createdAtText = new Date(user.createdAt).toLocaleDateString();
                    }
                    
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${createdAtText}</td>
                        <td>${isVip ? '<span class="vip-tag">VIP</span>' : '일반회원'}</td>
                        <td>${expiryText}</td>
                        <td>${user.vipStatus === 'pending' ? '승인 대기중' : '-'}</td>
                        <td>
                            ${isVip 
                                ? `<button class="action-button delete-button" onclick="changeVipStatus('${user.username}', false)">VIP 해제</button>`
                                : `<button class="action-button vip-button" onclick="changeVipStatus('${user.username}', true)">VIP 부여</button>`
                            }
                            <button class="action-button delete-button" onclick="deleteUser('${user.username}')">삭제</button>
                        </td>
                    `;
                    
                    userListBody.appendChild(row);
                });
            } catch (error) {
                console.error('사용자 목록 로드 중 오류:', error);
                showMessage('사용자 목록을 로드하는 중 오류가 발생했습니다.', 'error');
                
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" style="text-align: center; color: red;">사용자 데이터를 로드하는 중 오류가 발생했습니다.</td>`;
                userListBody.appendChild(row);
            }
        }
        
        // 페이지 로드 시 사용자 목록 불러오기
        window.addEventListener('load', () => {
            loadUsers();
            showMessage('관리자 페이지에 접속했습니다.', 'info');
        });
    </script>
</body>
</html>
