<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›Œí”„ìŠ¤íƒ€ ì½˜í…ì¸  í¬ë¦¬ì—ì´í„° - ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #8A4FFF;
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
            text-align: center;
        }
        
        /* ëŒ€ì‹œë³´ë“œ */
        .dashboard {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .stat-item {
            flex: 1;
            min-width: 200px;
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 15px;
            margin: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #8A4FFF;
        }
        
        /* ì‚¬ìš©ì ê´€ë¦¬ */
        .user-management {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        /* ë©¤ë²„ì‹­ ìƒíƒœ */
        .vip {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .pending {
            color: #FFC107;
            font-weight: bold;
        }
        
        .regular {
            color: #607D8B;
        }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .action-button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
            transition: background-color 0.3s;
        }
        
        .delete-button {
            background-color: #f44336;
            color: white;
        }
        
        .delete-button:hover {
            background-color: #d32f2f;
        }
        
        .vip-button {
            background-color: #8A4FFF;
            color: white;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .vip-button:hover {
            background-color: #7040E0;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(138, 79, 255, 0.3);
        }
        
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .stat-item {
                min-width: 100%;
                margin: 5px 0;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            .action-button {
                padding: 5px 10px;
                font-size: 12px;
            }
        }
        
        /* ë¡œë”© ì¸ë””ì¼€ì´í„° */
        #loadingIndicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        /* ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ */
        .refresh-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .refresh-button:hover {
            background-color: #3e8e41;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(62, 142, 65, 0.3);
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="admin-logo">
            <span class="logo-dot">ğŸŸ£</span>
            <span>ì›Œí”„ìŠ¤íƒ€ Content Creator</span>
        </div>
        <button class="back-button" onclick="goBack()">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <div class="admin-container">
        <h1 class="admin-title">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        
        <div id="messageContainer"></div>

        <div class="admin-card">
            <h2>ì‚¬ìš©ì ê´€ë¦¬</h2>
            <table class="user-list" id="userTable">
                <thead>
                    <tr>
                        <th>ì•„ì´ë””</th>
                        <th>ê°€ì…ì¼</th>
                        <th>ë©¤ë²„ì‹­ ìƒíƒœ</th>
                        <th>VIP ë§Œë£Œì¼</th>
                        <th>ìƒíƒœ</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- ì‚¬ìš©ì ëª©ë¡ì´ JavaScriptë¡œ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                </tbody>
            </table>
        </div>

        <div class="admin-card">
            <h2>í†µê³„</h2>
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>ì´ ì‚¬ìš©ì:</strong> <span id="totalUsers">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>VIP ì‚¬ìš©ì:</strong> <span id="vipUsers">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>ì˜¤ëŠ˜ ê°€ì…í•œ ì‚¬ìš©ì:</strong> <span id="todayNewUsers">0</span>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingIndicator">ë¡œë”© ì¤‘...</div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // ì•„ë˜ì˜ ì½”ë“œëŠ” í˜„ì¬ ì‚¬ìš©ìê°€ ê´€ë¦¬ìì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤
            if (localStorage.getItem('smart_content_current_user') !== '1111') {
                alert('ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                window.location.href = '/';
                return;
            }
            
            // ì´ˆê¸° ì‚¬ìš©ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            fetchUsers();
            
            // 30ì´ˆë§ˆë‹¤ ì‚¬ìš©ì ëª©ë¡ì„ ìë™ìœ¼ë¡œ ê°±ì‹ í•©ë‹ˆë‹¤
            setInterval(fetchUsers, 30000);
            
            // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì¶”ê°€
            const refreshButton = document.createElement('button');
            refreshButton.innerText = 'ëª©ë¡ ìƒˆë¡œê³ ì¹¨';
            refreshButton.className = 'refresh-button';
            refreshButton.onclick = fetchUsers;
            document.querySelector('.user-management h2').after(refreshButton);
        });
        
        // ì‚¬ìš©ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        async function fetchUsers() {
            try {
                console.log('ê´€ë¦¬ì í˜ì´ì§€: ì‚¬ìš©ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹œë„');
                document.getElementById('loadingIndicator').style.display = 'block';
                
                // APIì—ì„œ ì‚¬ìš©ì ëª©ë¡ ìš”ì²­ (ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•œ timestamp ì¶”ê°€)
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/admin?adminUsername=1111&t=${timestamp}`);
                
                // API ì‘ë‹µ ì²˜ë¦¬
                if (response.ok) {
                    const data = await response.json();
                    console.log('API ì‘ë‹µ:', data);
                    
                    if (data.success) {
                        // APIì—ì„œ ê°€ì ¸ì˜¨ ì‚¬ìš©ì ëª©ë¡ í‘œì‹œ
                        displayUsers(data.users || []);
                        
                        // í†µê³„ ì—…ë°ì´íŠ¸
                        updateStats(data.users || []);
                        
                        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                        showMessage('success', `${data.users.length}ëª…ì˜ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                    } else {
                        console.error('API ì˜¤ë¥˜:', data.message);
                        showMessage('error', `API ì˜¤ë¥˜: ${data.message}`);
                        
                        // APIì—ì„œ ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì˜ ë°ì´í„° ì‚¬ìš©
                        fallbackToLocalStorage();
                    }
                } else {
                    const errorText = await response.text();
                    console.error('API ìš”ì²­ ì‹¤íŒ¨:', response.status, errorText);
                    showMessage('error', `API ìš”ì²­ ì‹¤íŒ¨ (${response.status}): ${errorText}`);
                    
                    // API ìš”ì²­ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì˜ ë°ì´í„° ì‚¬ìš©
                    fallbackToLocalStorage();
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                showMessage('error', `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
                
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±ì˜ ê²½ìš° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì˜ ë°ì´í„° ì‚¬ìš©
                fallbackToLocalStorage();
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (í´ë°±)
        function fallbackToLocalStorage() {
            try {
                console.log('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°');
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const users = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                
                if (users.length === 0) {
                    showMessage('warning', 'ì €ì¥ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤. íšŒì›ê°€ì… í˜ì´ì§€ì—ì„œ ìƒˆ ì‚¬ìš©ìë¥¼ ë“±ë¡í•˜ì„¸ìš”.');
                } else {
                    // ì‚¬ìš©ì ëª©ë¡ í‘œì‹œ
                    displayUsers(users);
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸
                    updateStats(users);
                    
                    showMessage('info', `ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ${users.length}ëª…ì˜ ì‚¬ìš©ìë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                }
            } catch (error) {
                console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì ‘ê·¼ ì˜¤ë¥˜:', error);
                showMessage('error', `ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì ‘ê·¼ ì˜¤ë¥˜: ${error.message}`);
                
                // ë¹ˆ ëª©ë¡ í‘œì‹œ
                displayUsers([]);
                updateStats([]);
            }
        }
        
        // ì‚¬ìš©ì ëª©ë¡ í‘œì‹œ í•¨ìˆ˜
        function displayUsers(users) {
            const userTableBody = document.getElementById('userTableBody');
            userTableBody.innerHTML = '';
            
            if (users.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="6" style="text-align: center; padding: 20px;">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>`;
                userTableBody.appendChild(emptyRow);
                return;
            }
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                // VIP ìƒíƒœ ê²°ì • (membershipTypeê³¼ vipStatus ëª¨ë‘ í™•ì¸)
                const isVip = (user.membershipType === 'vip' || user.membership_type === 'vip') && 
                              (user.vipStatus === 'approved' || user.vip_status === 'approved');
                const isPending = user.vipStatus === 'pending' || user.vip_status === 'pending';
                
                // ë©¤ë²„ì‹­ ë§Œë£Œì¼ í¬ë§·íŒ…
                let expiryDate = user.membershipExpiry || user.membership_expiry;
                expiryDate = expiryDate 
                    ? new Date(expiryDate).toLocaleDateString('ko-KR')
                    : 'ì—†ìŒ';
                    
                // VIPê°€ ì•„ë‹ˆê±°ë‚˜ ë§Œë£Œëœ ê²½ìš°
                if (!isVip) {
                    expiryDate = 'ì—†ìŒ';
                }
                
                // ìƒì„±ì¼ í¬ë§·íŒ…
                const createdDate = user.createdAt || user.created_at;
                const formattedDate = createdDate 
                    ? new Date(createdDate).toLocaleDateString('ko-KR')
                    : 'ì•Œ ìˆ˜ ì—†ìŒ';
                
                // VIP ìƒíƒœì— ë”°ë¥¸ í´ë˜ìŠ¤ ë° í…ìŠ¤íŠ¸
                let statusClass = '';
                let statusText = '';
                
                if (isVip) {
                    statusClass = 'vip';
                    statusText = 'VIP';
                } else if (isPending) {
                    statusClass = 'pending';
                    statusText = 'ìŠ¹ì¸ ëŒ€ê¸°ì¤‘';
                } else {
                    statusClass = 'regular';
                    statusText = 'ì¼ë°˜';
                }
                
                // ì‚¬ìš©ìëª…
                const username = user.username;
                
                // í–‰ ë‚´ìš© ì„¤ì •
                row.innerHTML = `
                    <td>${username}</td>
                    <td>${formattedDate}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${expiryDate}</td>
                    <td>${user.depositName || user.deposit_name || '-'}</td>
                    <td>
                        <button class="vip-button" onclick="approveVip('${username}', '${user.depositName || user.deposit_name || username}')">VIP ìŠ¹ì¸</button>
                    </td>
                `;
                
                userTableBody.appendChild(row);
            });
        }
        
        // VIP ìˆ˜ë™ ìŠ¹ì¸ í•¨ìˆ˜
        async function approveVip(username, depositName) {
            if (!confirm(`${username} ì‚¬ìš©ìë¥¼ VIPë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                const apiUrl = `/api/directApprove?username=${encodeURIComponent(username)}&depositName=${encodeURIComponent(depositName)}&action=approve`;
                
                console.log('VIP ìŠ¹ì¸ API í˜¸ì¶œ:', apiUrl);
                
                // API í˜¸ì¶œ
                const response = await fetch(apiUrl);
                
                if (response.ok) {
                    const responseText = await response.text();
                    console.log('VIP ìŠ¹ì¸ ì„±ê³µ:', responseText);
                    
                    showMessage('success', `${username} ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ VIPë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    
                    // ì‚¬ìš©ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    fetchUsers();
                } else {
                    const errorText = await response.text();
                    console.error('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ API ì˜¤ë¥˜:', errorText);
                    
                    showMessage('error', `ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${errorText}`);
                }
            } catch (error) {
                console.error('VIP ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                showMessage('error', `VIP ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStats(users) {
            // ì „ì²´ ì‚¬ìš©ì ìˆ˜
            document.getElementById('totalUsers').textContent = users.length;
            
            // VIP ì‚¬ìš©ì ìˆ˜ (membershipTypeê³¼ vipStatus ëª¨ë‘ í™•ì¸)
            const vipCount = users.filter(user => 
                (user.membershipType === 'vip' || user.membership_type === 'vip') && 
                (user.vipStatus === 'approved' || user.vip_status === 'approved')
            ).length;
            document.getElementById('vipUsers').textContent = vipCount;
            
            // ì˜¤ëŠ˜ ê°€ì…í•œ ì‚¬ìš©ì ìˆ˜
            const today = new Date().toISOString().split('T')[0];
            const todayUsers = users.filter(user => {
                const createdAt = user.createdAt || user.created_at;
                if (!createdAt) return false;
                return createdAt.split('T')[0] === today;
            }).length;
            document.getElementById('todayNewUsers').textContent = todayUsers;
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(type, text) {
            const messageContainer = document.getElementById('messageContainer');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = text;
            
            // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
            messageContainer.innerHTML = '';
            messageContainer.appendChild(messageElement);
            
            // 3ì´ˆ í›„ ë©”ì‹œì§€ ìë™ ì‚­ì œ
            setTimeout(() => {
                messageElement.style.opacity = '0';
                setTimeout(() => messageElement.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>
