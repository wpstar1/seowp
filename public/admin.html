<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›Œí”„ìŠ¤íƒ€ ì½˜í…ì¸  í¬ë¦¬ì—ì´í„° - ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .admin-header {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .logo-dot {
            color: #8A4FFF;
            font-size: 28px;
            margin-right: 8px;
        }
        .admin-title {
            margin: 20px 0;
            color: #333;
        }
        .admin-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .admin-card h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .user-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .user-list th, .user-list td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .user-list th {
            background-color: #f9f9f9;
        }
        .user-list tr:hover {
            background-color: #f5f5f5;
        }
        .vip-tag {
            background-color: #8A4FFF;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .action-button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .vip-button {
            background-color: #8A4FFF;
            color: white;
        }
        .delete-button {
            background-color: #E84855;
            color: white;
        }
        .back-button {
            padding: 8px 15px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .message {
            padding: 10px 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="admin-logo">
            <span class="logo-dot">ğŸŸ£</span>
            <span>ì›Œí”„ìŠ¤íƒ€ Content Creator</span>
        </div>
        <button class="back-button" onclick="goBack()">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <div class="admin-container">
        <h1 class="admin-title">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        
        <div id="message-container"></div>

        <div class="admin-card">
            <h2>ì‚¬ìš©ì ê´€ë¦¬</h2>
            <table class="user-list" id="user-table">
                <thead>
                    <tr>
                        <th>ì•„ì´ë””</th>
                        <th>ê°€ì…ì¼</th>
                        <th>ë©¤ë²„ì‹­ ìƒíƒœ</th>
                        <th>VIP ë§Œë£Œì¼</th>
                        <th>ìƒíƒœ</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="user-list-body">
                    <!-- ì‚¬ìš©ì ëª©ë¡ì´ JavaScriptë¡œ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                </tbody>
            </table>
        </div>

        <div class="admin-card">
            <h2>í†µê³„</h2>
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>ì´ ì‚¬ìš©ì:</strong> <span id="total-users">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>VIP ì‚¬ìš©ì:</strong> <span id="vip-users">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>ì˜¤ëŠ˜ ìƒì„±ëœ ì½˜í…ì¸ :</strong> <span id="contents-today">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>ì´ ì½˜í…ì¸  ìƒì„±ìˆ˜:</strong> <span id="total-contents">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        function goBack() {
            window.location.href = "/";
        }

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(text, type) {
            const messageContainer = document.getElementById('message-container');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = text;
            messageContainer.appendChild(messageElement);
            
            // ìë™ ì œê±°
            setTimeout(() => {
                messageElement.style.opacity = '0';
                messageElement.style.transition = 'opacity 0.5s';
                setTimeout(() => messageContainer.removeChild(messageElement), 500);
            }, 4000);
        }

        // APIë¡œ ì‚¬ìš©ì ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchUsers() {
            try {
                // ê´€ë¦¬ì ê³„ì • í™•ì¸
                const currentUser = localStorage.getItem('smart_content_current_user');
                if (currentUser !== '1111') {
                    showMessage('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    setTimeout(() => {
                        window.location.href = "/";
                    }, 2000);
                    return [];
                }
                
                // API í˜¸ì¶œ (ê´€ë¦¬ì API)
                try {
                    const response = await fetch(`/api/admin?adminUsername=${currentUser}`);
                    if (!response.ok) {
                        throw new Error('API ìš”ì²­ ì‹¤íŒ¨');
                    }
                    
                    const apiData = await response.json();
                    
                    // API ì—°ê²° ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¡œ í´ë°±
                    if (!apiData.success) {
                        throw new Error(apiData.message || 'API ìš”ì²­ ì‹¤íŒ¨');
                    }
                    
                    // ì‚¬ìš©ì ëª©ë¡ API í˜¸ì¶œ
                    let allUsers = [];
                    
                    // VIP ì‹ ì²­ ì¤‘ì¸ ìœ ì € ëª©ë¡
                    const pendingUsers = apiData.requests || [];
                    console.log('VIP ì‹ ì²­ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ì:', pendingUsers);
                    
                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì˜ ì‚¬ìš©ì ì •ë³´ë„ í•¨ê»˜ í‘œì‹œ (í´ë°±)
                    const localUsers = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                    
                    // ì¤‘ë³µ ì œê±° ë° í†µí•©
                    const localUsernames = new Set(localUsers.map(u => u.username));
                    
                    // ì‹¤ì œë¡œëŠ” ëª¨ë“  ì‚¬ìš©ìë¥¼ ê°€ì ¸ì˜¤ëŠ” APIê°€ í•„ìš”í•©ë‹ˆë‹¤.
                    // í˜„ì¬ëŠ” ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì™€ VIP ì‹ ì²­ì ëª©ë¡ë§Œ í†µí•©
                    allUsers = [...localUsers];
                    
                    // VIP ì‹ ì²­ì ì¤‘ ë¡œì»¬ì— ì—†ëŠ” ì‚¬ìš©ì ì¶”ê°€
                    pendingUsers.forEach(pendingUser => {
                        if (!localUsernames.has(pendingUser.username)) {
                            allUsers.push({
                                ...pendingUser,
                                membershipType: 'regular',
                                vipStatus: 'pending'
                            });
                        }
                    });
                    
                    return allUsers;
                } catch (error) {
                    console.warn('API ìš”ì²­ ì‹¤íŒ¨, ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¡œ í´ë°±:', error.message);
                    
                    // API ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë§Œ ì‚¬ìš©
                    const localUsers = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                    console.log('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ì:', localUsers);
                    
                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— admin ê³„ì •ì´ ì—†ìœ¼ë©´ ì¶”ê°€
                    if (!localUsers.some(user => user.username === '1111')) {
                        localUsers.push({
                            username: '1111',
                            password: '1111',
                            membershipType: 'vip',
                            vipStatus: 'approved',
                            createdAt: new Date().toISOString()
                        });
                        localStorage.setItem('smart_content_users', JSON.stringify(localUsers));
                    }
                    
                    return localUsers;
                }
            } catch (error) {
                console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                showMessage('ì‚¬ìš©ì ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                return [];
            }
        }

        // VIP ìƒíƒœ ë³€ê²½ í•¨ìˆ˜
        async function changeVipStatus(username, makeVip) {
            try {
                const currentUser = localStorage.getItem('smart_content_current_user');
                if (currentUser !== '1111') {
                    showMessage('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    return;
                }
                
                // API í˜¸ì¶œ (VIP ìŠ¹ì¸ API)
                const response = await fetch('/api/vip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        status: makeVip ? 'approved' : 'rejected',
                        approvedBy: currentUser
                    })
                });
                
                const result = await response.json();
                
                // API ì„±ê³µ
                if (result.success) {
                    showMessage(result.message || `${username} ì‚¬ìš©ìì˜ VIP ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    loadUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    return;
                }
                
                // API ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¡œ í´ë°±
                console.warn('API ìš”ì²­ ì‹¤íŒ¨, ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©:', result.message);
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                const users = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                const updatedUsers = users.map(user => {
                    if (user.username === username) {
                        if (makeVip) {
                            // VIPë¡œ ìŠ¹ì¸
                            const expiryDate = new Date();
                            expiryDate.setDate(expiryDate.getDate() + 30); // 30ì¼ ì¶”ê°€
                            
                            return {
                                ...user,
                                membershipType: 'vip',
                                vipStatus: 'approved',
                                membershipExpiry: expiryDate.toISOString()
                            };
                        } else {
                            // VIP ê±°ì ˆ
                            return {
                                ...user,
                                vipStatus: 'rejected'
                            };
                        }
                    }
                    return user;
                });
                
                localStorage.setItem('smart_content_users', JSON.stringify(updatedUsers));
                showMessage(`${username} ì‚¬ìš©ìì˜ VIP ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                loadUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('VIP ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error);
                showMessage('VIP ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì‚¬ìš©ì ì‚­ì œ í•¨ìˆ˜
        async function deleteUser(username) {
            // ì‚­ì œ í™•ì¸
            if (!confirm(`ì •ë§ ${username} ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            try {
                // í˜„ì¬ëŠ” ì‚­ì œ APIê°€ ì—†ìœ¼ë¯€ë¡œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë§Œ ë³€ê²½
                const users = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                const filteredUsers = users.filter(user => user.username !== username);
                
                if (users.length === filteredUsers.length) {
                    showMessage(`${username} ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
                    return;
                }
                
                localStorage.setItem('smart_content_users', JSON.stringify(filteredUsers));
                showMessage(`${username} ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                loadUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                showMessage('ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
        async function loadUsers() {
            const users = await fetchUsers();
            const userTableBody = document.getElementById('user-list-body');
            userTableBody.innerHTML = '';

            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('total-users').textContent = users.length;
            
            let vipCount = 0;
            
            // ì‚¬ìš©ì ëª©ë¡ ì±„ìš°ê¸°
            users.forEach(user => {
                const row = document.createElement('tr');

                // VIP íšŒì› ì¹´ìš´íŠ¸
                if (user.membershipType === 'vip' && user.vipStatus === 'approved') {
                    vipCount++;
                }

                // ì‚¬ìš©ì ì´ë¦„ ì—´
                const usernameCell = document.createElement('td');
                usernameCell.textContent = user.username;
                row.appendChild(usernameCell);

                // ê°€ì…ì¼ ì—´
                const createdAtCell = document.createElement('td');
                if (user.createdAt) {
                    const date = new Date(user.createdAt);
                    createdAtCell.textContent = date.toLocaleDateString();
                } else {
                    createdAtCell.textContent = 'ì •ë³´ ì—†ìŒ';
                }
                row.appendChild(createdAtCell);

                // ë©¤ë²„ì‹­ ìƒíƒœ ì—´
                const membershipCell = document.createElement('td');
                if (user.membershipType === 'vip' && user.vipStatus === 'approved') {
                    const vipTag = document.createElement('span');
                    vipTag.className = 'vip-tag';
                    vipTag.textContent = 'VIP';
                    membershipCell.appendChild(vipTag);
                } else {
                    membershipCell.textContent = 'ì¼ë°˜';
                }
                row.appendChild(membershipCell);

                // VIP ë§Œë£Œì¼ ì—´
                const expiryCell = document.createElement('td');
                if (user.membershipExpiry) {
                    const expiryDate = new Date(user.membershipExpiry);
                    expiryCell.textContent = expiryDate.toLocaleDateString();

                    // ë§Œë£Œì¼ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜ í‘œì‹œ
                    const today = new Date();
                    const diffTime = expiryDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays > 0) {
                        expiryCell.textContent += ` (${diffDays}ì¼ ë‚¨ìŒ)`;
                    } else {
                        expiryCell.textContent += ' (ë§Œë£Œë¨)';
                    }
                } else {
                    expiryCell.textContent = '-';
                }
                row.appendChild(expiryCell);

                // ìƒíƒœ ì—´
                const statusCell = document.createElement('td');
                if (user.vipStatus === 'pending') {
                    statusCell.textContent = 'VIP ìŠ¹ì¸ ëŒ€ê¸°ì¤‘';
                    statusCell.style.color = '#FFA000';
                } else if (user.vipStatus === 'rejected') {
                    statusCell.textContent = 'VIP ìŠ¹ì¸ ê±°ì ˆë¨';
                    statusCell.style.color = '#D32F2F';
                } else {
                    statusCell.textContent = 'ì •ìƒ';
                    statusCell.style.color = '#2E7D32';
                }
                row.appendChild(statusCell);

                // ì•¡ì…˜ ì—´
                const actionCell = document.createElement('td');
                
                // VIP ì „í™˜ ë²„íŠ¼ (ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ìë§Œ)
                if (user.vipStatus === 'pending') {
                    const approveBtn = document.createElement('button');
                    approveBtn.className = 'action-button vip-button';
                    approveBtn.textContent = 'VIP ìŠ¹ì¸';
                    approveBtn.onclick = () => changeVipStatus(user.username, true);
                    
                    const rejectBtn = document.createElement('button');
                    rejectBtn.className = 'action-button delete-button';
                    rejectBtn.textContent = 'ê±°ì ˆ';
                    rejectBtn.style.marginLeft = '5px';
                    rejectBtn.onclick = () => changeVipStatus(user.username, false);
                    
                    actionCell.appendChild(approveBtn);
                    actionCell.appendChild(rejectBtn);
                } else if (user.username !== '1111') { // ê´€ë¦¬ìëŠ” ì‚­ì œ ë¶ˆê°€
                    // ì‚­ì œ ë²„íŠ¼
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'action-button delete-button';
                    deleteBtn.textContent = 'ì‚­ì œ';
                    deleteBtn.onclick = () => deleteUser(user.username);
                    actionCell.appendChild(deleteBtn);
                }
                
                row.appendChild(actionCell);
                userTableBody.appendChild(row);
            });

            // VIP ì‚¬ìš©ì ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            document.getElementById('vip-users').textContent = vipCount;

            // ì½˜í…ì¸  í†µê³„ëŠ” ì•„ì§ êµ¬í˜„ë˜ì§€ ì•ŠìŒ
            document.getElementById('contents-today').textContent = '0';
            document.getElementById('total-contents').textContent = '0';
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('load', () => {
            loadUsers();
            showMessage('ê´€ë¦¬ì í˜ì´ì§€ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤.', 'info');
        });
    </script>
</body>
</html>
