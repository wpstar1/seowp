<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>워프스타 콘텐츠 크리에이터 - 관리자 페이지</title>
    <style>
        /* 기본 스타일 */
        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #8A4FFF;
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
            text-align: center;
        }
        
        /* 대시보드 */
        .dashboard {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .stat-item {
            flex: 1;
            min-width: 200px;
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 15px;
            margin: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #8A4FFF;
        }
        
        /* 사용자 관리 */
        .user-management {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        /* 멤버십 상태 */
        .vip {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .pending {
            color: #FFC107;
            font-weight: bold;
        }
        
        .regular {
            color: #607D8B;
        }
        
        /* 버튼 스타일 */
        .action-button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
            transition: background-color 0.3s;
        }
        
        .delete-button {
            background-color: #f44336;
            color: white;
        }
        
        .delete-button:hover {
            background-color: #d32f2f;
        }
        
        .vip-button {
            background-color: #8A4FFF;
            color: white;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .vip-button:hover {
            background-color: #7040E0;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(138, 79, 255, 0.3);
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .stat-item {
                min-width: 100%;
                margin: 5px 0;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            .action-button {
                padding: 5px 10px;
                font-size: 12px;
            }
        }
        
        /* 로딩 인디케이터 */
        #loadingIndicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        /* 새로고침 버튼 */
        .refresh-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .refresh-button:hover {
            background-color: #3e8e41;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(62, 142, 65, 0.3);
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="admin-logo">
            <span class="logo-dot">🟣</span>
            <span>워프스타 Content Creator</span>
        </div>
        <button class="back-button" onclick="goBack()">메인으로 돌아가기</button>
    </div>

    <div class="admin-container">
        <h1 class="admin-title">관리자 대시보드</h1>
        
        <div id="messageContainer"></div>

        <div class="admin-card">
            <h2>사용자 관리</h2>
            <table class="user-list" id="userTable">
                <thead>
                    <tr>
                        <th>아이디</th>
                        <th>가입일</th>
                        <th>멤버십 상태</th>
                        <th>VIP 만료일</th>
                        <th>상태</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- 사용자 목록이 JavaScript로 여기에 로드됩니다 -->
                </tbody>
            </table>
        </div>

        <div class="admin-card">
            <h2>통계</h2>
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>총 사용자:</strong> <span id="totalUsers">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>VIP 사용자:</strong> <span id="vipUsers">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>오늘 가입한 사용자:</strong> <span id="todayNewUsers">0</span>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingIndicator">로딩 중...</div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // 아래의 코드는 현재 사용자가 관리자인지 확인합니다
            if (localStorage.getItem('smart_content_current_user') !== '1111') {
                alert('관리자만 접근할 수 있습니다.');
                window.location.href = '/';
                return;
            }
            
            // 초기 사용자 목록 가져오기
            fetchUsers();
            
            // 30초마다 사용자 목록을 자동으로 갱신합니다
            setInterval(fetchUsers, 30000);
            
            // 새로고침 버튼 추가
            const refreshButton = document.createElement('button');
            refreshButton.innerText = '목록 새로고침';
            refreshButton.className = 'refresh-button';
            refreshButton.onclick = fetchUsers;
            document.querySelector('.user-management h2').after(refreshButton);
        });
        
        // 사용자 목록 가져오기 함수
        async function fetchUsers() {
            try {
                console.log('관리자 페이지: 사용자 목록 가져오기 시도');
                document.getElementById('loadingIndicator').style.display = 'block';
                
                // API에서 사용자 목록 요청 (캐시 방지를 위한 timestamp 추가)
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/admin?adminUsername=1111&t=${timestamp}`);
                
                // API 응답 처리
                if (response.ok) {
                    const data = await response.json();
                    console.log('API 응답:', data);
                    
                    if (data.success) {
                        // API에서 가져온 사용자 목록 표시
                        displayUsers(data.users || []);
                        
                        // 통계 업데이트
                        updateStats(data.users || []);
                        
                        // 성공 메시지 표시
                        showMessage('success', `${data.users.length}명의 사용자 데이터를 성공적으로 불러왔습니다.`);
                    } else {
                        console.error('API 오류:', data.message);
                        showMessage('error', `API 오류: ${data.message}`);
                        
                        // API에서 오류 발생 시 로컬 스토리지의 데이터 사용
                        fallbackToLocalStorage();
                    }
                } else {
                    const errorText = await response.text();
                    console.error('API 요청 실패:', response.status, errorText);
                    showMessage('error', `API 요청 실패 (${response.status}): ${errorText}`);
                    
                    // API 요청 실패 시 로컬 스토리지의 데이터 사용
                    fallbackToLocalStorage();
                }
            } catch (error) {
                console.error('사용자 목록 가져오기 오류:', error);
                showMessage('error', `네트워크 오류: ${error.message}`);
                
                // 네트워크 오류 등의 경우 로컬 스토리지의 데이터 사용
                fallbackToLocalStorage();
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
        
        // 로컬 스토리지에서 사용자 목록 가져오기 (폴백)
        function fallbackToLocalStorage() {
            try {
                console.log('로컬 스토리지에서 사용자 목록 가져오기');
                
                // 로컬 스토리지에서 사용자 목록 가져오기
                const users = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                
                if (users.length === 0) {
                    showMessage('warning', '저장된 사용자가 없습니다. 회원가입 페이지에서 새 사용자를 등록하세요.');
                } else {
                    // 사용자 목록 표시
                    displayUsers(users);
                    
                    // 통계 업데이트
                    updateStats(users);
                    
                    showMessage('info', `데이터베이스 연결 실패. 로컬 스토리지에서 ${users.length}명의 사용자를 불러왔습니다.`);
                }
            } catch (error) {
                console.error('로컬 스토리지 접근 오류:', error);
                showMessage('error', `로컬 스토리지 접근 오류: ${error.message}`);
                
                // 빈 목록 표시
                displayUsers([]);
                updateStats([]);
            }
        }
        
        // 사용자 목록 표시 함수
        function displayUsers(users) {
            const userTableBody = document.getElementById('userTableBody');
            userTableBody.innerHTML = '';
            
            if (users.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="6" style="text-align: center; padding: 20px;">등록된 사용자가 없습니다.</td>`;
                userTableBody.appendChild(emptyRow);
                return;
            }
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                // VIP 상태 결정 (membershipType과 vipStatus 모두 확인)
                const isVip = (user.membershipType === 'vip' || user.membership_type === 'vip') && 
                              (user.vipStatus === 'approved' || user.vip_status === 'approved');
                const isPending = user.vipStatus === 'pending' || user.vip_status === 'pending';
                
                // 멤버십 만료일 포맷팅
                let expiryDate = user.membershipExpiry || user.membership_expiry;
                expiryDate = expiryDate 
                    ? new Date(expiryDate).toLocaleDateString('ko-KR')
                    : '없음';
                    
                // VIP가 아니거나 만료된 경우
                if (!isVip) {
                    expiryDate = '없음';
                }
                
                // 생성일 포맷팅
                const createdDate = user.createdAt || user.created_at;
                const formattedDate = createdDate 
                    ? new Date(createdDate).toLocaleDateString('ko-KR')
                    : '알 수 없음';
                
                // VIP 상태에 따른 클래스 및 텍스트
                let statusClass = '';
                let statusText = '';
                
                if (isVip) {
                    statusClass = 'vip';
                    statusText = 'VIP';
                } else if (isPending) {
                    statusClass = 'pending';
                    statusText = '승인 대기중';
                } else {
                    statusClass = 'regular';
                    statusText = '일반';
                }
                
                // 사용자명
                const username = user.username;
                
                // 행 내용 설정
                row.innerHTML = `
                    <td>${username}</td>
                    <td>${formattedDate}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${expiryDate}</td>
                    <td>${user.depositName || user.deposit_name || '-'}</td>
                    <td>
                        <button class="vip-button" onclick="approveVip('${username}', '${user.depositName || user.deposit_name || username}')">VIP 승인</button>
                    </td>
                `;
                
                userTableBody.appendChild(row);
            });
        }
        
        // VIP 수동 승인 함수
        async function approveVip(username, depositName) {
            if (!confirm(`${username} 사용자를 VIP로 승인하시겠습니까?`)) {
                return;
            }
            
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                const apiUrl = `/api/directApprove?username=${encodeURIComponent(username)}&depositName=${encodeURIComponent(depositName)}&action=approve`;
                
                console.log('VIP 승인 API 호출:', apiUrl);
                
                // API 호출
                const response = await fetch(apiUrl);
                
                if (response.ok) {
                    const responseText = await response.text();
                    console.log('VIP 승인 성공:', responseText);
                    
                    showMessage('success', `${username} 사용자가 성공적으로 VIP로 승인되었습니다.`);
                    
                    // 사용자 목록 새로고침
                    fetchUsers();
                } else {
                    const errorText = await response.text();
                    console.error('승인 처리 중 API 오류:', errorText);
                    
                    showMessage('error', `승인 처리 중 오류가 발생했습니다: ${errorText}`);
                }
            } catch (error) {
                console.error('VIP 승인 처리 중 오류:', error);
                showMessage('error', `VIP 승인 처리 중 네트워크 오류가 발생했습니다: ${error.message}`);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
        
        // 통계 업데이트 함수
        function updateStats(users) {
            // 전체 사용자 수
            document.getElementById('totalUsers').textContent = users.length;
            
            // VIP 사용자 수 (membershipType과 vipStatus 모두 확인)
            const vipCount = users.filter(user => 
                (user.membershipType === 'vip' || user.membership_type === 'vip') && 
                (user.vipStatus === 'approved' || user.vip_status === 'approved')
            ).length;
            document.getElementById('vipUsers').textContent = vipCount;
            
            // 오늘 가입한 사용자 수
            const today = new Date().toISOString().split('T')[0];
            const todayUsers = users.filter(user => {
                const createdAt = user.createdAt || user.created_at;
                if (!createdAt) return false;
                return createdAt.split('T')[0] === today;
            }).length;
            document.getElementById('todayNewUsers').textContent = todayUsers;
        }
        
        // 메시지 표시 함수
        function showMessage(type, text) {
            const messageContainer = document.getElementById('messageContainer');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = text;
            
            // 기존 메시지 제거
            messageContainer.innerHTML = '';
            messageContainer.appendChild(messageElement);
            
            // 3초 후 메시지 자동 삭제
            setTimeout(() => {
                messageElement.style.opacity = '0';
                setTimeout(() => messageElement.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>
