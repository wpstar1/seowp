<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>워프스타 콘텐츠 크리에이터 - 관리자 페이지</title>
    <style>
        /* 기본 스타일 */
        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #8A4FFF;
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
            text-align: center;
        }
        
        /* 대시보드 */
        .dashboard {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .stat-item {
            flex: 1;
            min-width: 200px;
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 15px;
            margin: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #8A4FFF;
        }
        
        /* 사용자 관리 */
        .user-management {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        /* 멤버십 상태 */
        .vip {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .pending {
            color: #FFC107;
            font-weight: bold;
        }
        
        .regular {
            color: #607D8B;
        }
        
        /* 버튼 스타일 */
        .action-button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
            transition: background-color 0.3s;
        }
        
        .delete-button {
            background-color: #f44336;
            color: white;
        }
        
        .delete-button:hover {
            background-color: #d32f2f;
        }
        
        .vip-button {
            background-color: #8A4FFF;
            color: white;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .vip-button:hover {
            background-color: #7040E0;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(138, 79, 255, 0.3);
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .stat-item {
                min-width: 100%;
                margin: 5px 0;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            .action-button {
                padding: 5px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="admin-logo">
            <span class="logo-dot">🟣</span>
            <span>워프스타 Content Creator</span>
        </div>
        <button class="back-button" onclick="goBack()">메인으로 돌아가기</button>
    </div>

    <div class="admin-container">
        <h1 class="admin-title">관리자 대시보드</h1>
        
        <div id="message-container"></div>

        <div class="admin-card">
            <h2>사용자 관리</h2>
            <table class="user-list" id="user-table">
                <thead>
                    <tr>
                        <th>아이디</th>
                        <th>가입일</th>
                        <th>멤버십 상태</th>
                        <th>VIP 만료일</th>
                        <th>상태</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="user-list-body">
                    <!-- 사용자 목록이 JavaScript로 여기에 로드됩니다 -->
                </tbody>
            </table>
        </div>

        <div class="admin-card">
            <h2>통계</h2>
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>총 사용자:</strong> <span id="total-users">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>VIP 사용자:</strong> <span id="vip-users">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>오늘 생성된 콘텐츠:</strong> <span id="contents-today">0</span>
                </div>
                <div style="min-width: 200px; margin-bottom: 15px;">
                    <strong>총 콘텐츠 생성수:</strong> <span id="total-contents">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 메인으로 돌아가기
        function goBack() {
            window.location.href = "/";
        }

        // 메시지 표시 함수
        function showMessage(text, type) {
            const messageContainer = document.getElementById('message-container');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = text;
            messageContainer.appendChild(messageElement);
            
            // 자동 제거
            setTimeout(() => {
                messageElement.style.opacity = '0';
                messageElement.style.transition = 'opacity 0.5s';
                setTimeout(() => messageContainer.removeChild(messageElement), 500);
            }, 4000);
        }

        // API로 사용자 데이터 가져오기
        async function fetchUsers() {
            try {
                // 관리자 계정 확인
                const currentUser = localStorage.getItem('smart_content_current_user');
                if (currentUser !== '1111') {
                    showMessage('관리자 권한이 필요합니다.', 'error');
                    setTimeout(() => {
                        window.location.href = "/";
                    }, 2000);
                    return [];
                }
                
                // API 호출 (관리자 API)
                try {
                    const response = await fetch(`/api/admin?adminUsername=${currentUser}`);
                    if (!response.ok) {
                        throw new Error('API 요청 실패');
                    }
                    
                    const apiData = await response.json();
                    
                    // API 연결 실패 시 로컬 스토리지로 폴백
                    if (!apiData.success) {
                        throw new Error(apiData.message || 'API 요청 실패');
                    }
                    
                    // 사용자 목록 API 호출
                    let allUsers = [];
                    
                    // VIP 신청 중인 유저 목록
                    const pendingUsers = apiData.requests || [];
                    console.log('VIP 신청 대기 중인 사용자:', pendingUsers);
                    
                    // 전체 사용자 목록
                    if (apiData.users && Array.isArray(apiData.users)) {
                        console.log('API에서 가져온 모든 사용자:', apiData.users);
                        allUsers = apiData.users;
                    } else {
                        // API에서 사용자 목록을 가져오지 못한 경우 로컬 스토리지 사용
                        const localUsers = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                        
                        // 중복 제거 및 통합
                        const localUsernames = new Set(localUsers.map(u => u.username));
                        
                        // 로컬 스토리지 사용자 목록 사용
                        allUsers = [...localUsers];
                        
                        // VIP 신청자 중 로컬에 없는 사용자 추가
                        pendingUsers.forEach(pendingUser => {
                            if (!localUsernames.has(pendingUser.username)) {
                                allUsers.push({
                                    ...pendingUser,
                                    membershipType: 'regular',
                                    vipStatus: 'pending'
                                });
                            }
                        });
                    }
                    
                    return allUsers;
                } catch (error) {
                    console.warn('API 요청 실패, 로컬 스토리지로 폴백:', error.message);
                    
                    // API 실패 시 로컬 스토리지만 사용
                    const localUsers = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                    console.log('로컬 스토리지 사용자:', localUsers);
                    
                    // 로컬 스토리지에 admin 계정이 없으면 추가
                    if (!localUsers.some(user => user.username === '1111')) {
                        localUsers.push({
                            username: '1111',
                            password: '1111',
                            membershipType: 'vip',
                            vipStatus: 'approved',
                            createdAt: new Date().toISOString()
                        });
                        localStorage.setItem('smart_content_users', JSON.stringify(localUsers));
                    }
                    
                    return localUsers;
                }
            } catch (error) {
                console.error('데이터 가져오기 오류:', error);
                showMessage('사용자 데이터를 가져오는 중 오류가 발생했습니다.', 'error');
                return [];
            }
        }

        // VIP 상태 변경 함수
        async function changeVipStatus(username, makeVip) {
            try {
                const currentUser = localStorage.getItem('smart_content_current_user');
                if (currentUser !== '1111') {
                    showMessage('관리자 권한이 필요합니다.', 'error');
                    return;
                }
                
                // API 호출 (VIP 승인 API)
                const response = await fetch('/api/vip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        status: makeVip ? 'approved' : 'rejected',
                        approvedBy: currentUser
                    })
                });
                
                const result = await response.json();
                
                // API 성공
                if (result.success) {
                    showMessage(result.message || `${username} 사용자의 VIP 상태가 변경되었습니다.`, 'success');
                    loadUsers(); // 목록 새로고침
                    return;
                }
                
                // API 실패 시 로컬 스토리지로 폴백
                console.warn('API 요청 실패, 로컬 스토리지 사용:', result.message);
                
                // 로컬 스토리지 업데이트
                const users = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                const updatedUsers = users.map(user => {
                    if (user.username === username) {
                        if (makeVip) {
                            // VIP로 승인
                            const expiryDate = new Date();
                            expiryDate.setDate(expiryDate.getDate() + 30); // 30일 추가
                            
                            return {
                                ...user,
                                membershipType: 'vip',
                                vipStatus: 'approved',
                                membershipExpiry: expiryDate.toISOString()
                            };
                        } else {
                            // VIP 거절
                            return {
                                ...user,
                                vipStatus: 'rejected'
                            };
                        }
                    }
                    return user;
                });
                
                localStorage.setItem('smart_content_users', JSON.stringify(updatedUsers));
                showMessage(`${username} 사용자의 VIP 상태가 변경되었습니다.`, 'success');
                loadUsers(); // 목록 새로고침
            } catch (error) {
                console.error('VIP 상태 변경 중 오류:', error);
                showMessage('VIP 상태 변경 중 오류가 발생했습니다.', 'error');
            }
        }

        // 사용자 삭제 함수
        async function deleteUser(username) {
            // 삭제 확인
            if (!confirm(`정말 ${username} 사용자를 삭제하시겠습니까?`)) {
                return;
            }
            
            try {
                // 현재는 삭제 API가 없으므로 로컬 스토리지만 변경
                const users = JSON.parse(localStorage.getItem('smart_content_users') || '[]');
                const filteredUsers = users.filter(user => user.username !== username);
                
                if (users.length === filteredUsers.length) {
                    showMessage(`${username} 사용자를 찾을 수 없습니다.`, 'error');
                    return;
                }
                
                localStorage.setItem('smart_content_users', JSON.stringify(filteredUsers));
                showMessage(`${username} 사용자가 삭제되었습니다.`, 'success');
                loadUsers(); // 목록 새로고침
            } catch (error) {
                console.error('사용자 삭제 중 오류:', error);
                showMessage('사용자 삭제 중 오류가 발생했습니다.', 'error');
            }
        }

        // 사용자 목록 로드 함수
        async function loadUsers() {
            const users = await fetchUsers();
            const userTableBody = document.getElementById('user-list-body');
            userTableBody.innerHTML = '';

            // 통계 업데이트
            document.getElementById('total-users').textContent = users.length;
            
            let vipCount = 0;
            
            // 사용자 목록 채우기
            users.forEach(user => {
                const row = document.createElement('tr');

                // VIP 회원 카운트
                if (user.membershipType === 'vip' && user.vipStatus === 'approved') {
                    vipCount++;
                }

                // 사용자 이름 열
                const usernameCell = document.createElement('td');
                usernameCell.textContent = user.username;
                row.appendChild(usernameCell);

                // 가입일 열
                const createdAtCell = document.createElement('td');
                if (user.createdAt) {
                    const date = new Date(user.createdAt);
                    createdAtCell.textContent = date.toLocaleDateString();
                } else {
                    createdAtCell.textContent = '정보 없음';
                }
                row.appendChild(createdAtCell);

                // 멤버십 상태 열
                const membershipCell = document.createElement('td');
                if (user.membershipType === 'vip' && user.vipStatus === 'approved') {
                    const vipTag = document.createElement('span');
                    vipTag.className = 'vip-tag';
                    vipTag.textContent = 'VIP';
                    membershipCell.appendChild(vipTag);
                } else {
                    membershipCell.textContent = '일반';
                }
                row.appendChild(membershipCell);

                // VIP 만료일 열
                const expiryCell = document.createElement('td');
                if (user.membershipExpiry) {
                    const expiryDate = new Date(user.membershipExpiry);
                    expiryCell.textContent = expiryDate.toLocaleDateString();

                    // 만료일까지 남은 일수 표시
                    const today = new Date();
                    const diffTime = expiryDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays > 0) {
                        expiryCell.textContent += ` (${diffDays}일 남음)`;
                    } else {
                        expiryCell.textContent += ' (만료됨)';
                    }
                } else {
                    expiryCell.textContent = '-';
                }
                row.appendChild(expiryCell);

                // 상태 열
                const statusCell = document.createElement('td');
                if (user.vipStatus === 'pending') {
                    statusCell.textContent = 'VIP 승인 대기중';
                    statusCell.style.color = '#FFA000';
                } else if (user.vipStatus === 'rejected') {
                    statusCell.textContent = 'VIP 승인 거절됨';
                    statusCell.style.color = '#D32F2F';
                } else {
                    statusCell.textContent = '정상';
                    statusCell.style.color = '#2E7D32';
                }
                row.appendChild(statusCell);

                // 액션 열
                const actionCell = document.createElement('td');
                
                // VIP 전환 버튼 (대기 중인 사용자만)
                if (user.vipStatus === 'pending') {
                    const approveBtn = document.createElement('button');
                    approveBtn.className = 'action-button vip-button';
                    approveBtn.textContent = 'VIP 승인';
                    approveBtn.onclick = () => changeVipStatus(user.username, true);
                    
                    const rejectBtn = document.createElement('button');
                    rejectBtn.className = 'action-button delete-button';
                    rejectBtn.textContent = '거절';
                    rejectBtn.style.marginLeft = '5px';
                    rejectBtn.onclick = () => changeVipStatus(user.username, false);
                    
                    actionCell.appendChild(approveBtn);
                    actionCell.appendChild(rejectBtn);
                } else if (user.username !== '1111') { // 관리자는 삭제 불가
                    // 삭제 버튼
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'action-button delete-button';
                    deleteBtn.textContent = '삭제';
                    deleteBtn.onclick = () => deleteUser(user.username);
                    actionCell.appendChild(deleteBtn);
                }
                
                // VIP 승인 버튼 추가
                const vipApproveBtn = document.createElement('button');
                vipApproveBtn.className = 'action-button vip-button';
                vipApproveBtn.textContent = 'VIP 승인';
                vipApproveBtn.onclick = async () => {
                    try {
                        const apiUrl = `/api/directApprove?username=${encodeURIComponent(user.username)}&action=approve`;
                        
                        // API 호출
                        const response = await fetch(apiUrl);
                        
                        if (response.ok) {
                            alert(`${user.username} 사용자가 성공적으로 VIP로 승인되었습니다.`);
                            // 사용자 목록 새로고침
                            loadUsers();
                        } else {
                            const errorText = await response.text();
                            alert(`승인 처리 중 오류가 발생했습니다: ${errorText}`);
                        }
                    } catch (error) {
                        console.error('VIP 승인 처리 중 오류:', error);
                        alert('VIP 승인 처리 중 네트워크 오류가 발생했습니다.');
                    }
                };
                actionCell.appendChild(vipApproveBtn);
                
                row.appendChild(actionCell);
                userTableBody.appendChild(row);
            });

            // VIP 사용자 카운트 업데이트
            document.getElementById('vip-users').textContent = vipCount;

            // 콘텐츠 통계는 아직 구현되지 않음
            document.getElementById('contents-today').textContent = '0';
            document.getElementById('total-contents').textContent = '0';
        }
        
        // 페이지 로드 시 사용자 목록 불러오기
        window.addEventListener('load', () => {
            loadUsers();
            showMessage('관리자 페이지에 접속했습니다.', 'info');
        });
    </script>
</body>
</html>
